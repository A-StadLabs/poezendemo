<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="poes-contract">
  <template>
    <iron-ajax
       auto
       url="{{contracturl}}"
       handle-as="json"
       on-response="handleResponse"
       last-response="{{response}}"></iron-ajax>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'poes-contract',

      properties: {
        foo: {
          type: String,
          value: 'poes-contract',
          notify: true
        },
        web3: {
          type: Object,
          observer: "_web3"
        },
        webready: {
          observer: "_web3"
        },
        balance: {
          type: Number,
          notify: true,
          observer: "_balance"
        },
        account: {

        },
        contract: {
          type: String,
          observer: "_contract"
        },
        contractaddress: {
          type: String
        },
        globalkeystore: {
          type: Object,
          observer: "_keystore"
        }
      },

      ready: function(){
        
      },

      _web3: function(){
        console.log("poes contract kent web3js ", this.web3);
        this.balance = this.web3.fromWei(this.web3.eth.getBalance(this.account).toNumber(), 'ether');
      },

      _balance: function(){
        console.log("current balance for account ",this.account, ": ",this.balance);
      },

      _contract: function(){
        console.log('YOOOOO');
        this.contracturl = this.resolveUrl('../../contracts/'+this.contract);
        console.log("Got contract! ", JSON.stringify(this.contractjson));
      },

      handleResponse: function(){
        this.contractjson = this.response;
        console.log("Contract JSON: ", this.contractjson);
        this.runContract();
      },

      _keystore: function(){
        console.log("KEYSTORE: ", this.globalkeystore);
      },

      runContract: function(){
        var self = this;

        this.web3.eth.getGasPrice(function(err, result){
          //console.log("GASPRICE: ", result.toNumber(10));
          var gasPrice = result.toNumber(10);
          var txOptions = {
            gasPrice: gasPrice,
            gasLimit: 3000000,
            value: 100000000,
            nonce: 3,
            to: self.contractaddress
          };

          console.log("ABI: ",self.globalkeystore);

          var registerTx = lightwallet.txutils.functionTx(self.contractjson.abi, 'get', [], txOptions)
          var signedRegisterTx = self.globalkeystore.signTx(registerTx, 'testing', self.account)

           // inject signedRegisterTx into the network...
           console.log('Signed register key TX: ' + signedRegisterTx)
           console.log('')

          });
        }
    });
  })();
  </script>
</dom-module>
