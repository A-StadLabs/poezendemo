<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="poes-contract">
  <template>
    <iron-ajax
       auto
       url="{{contracturl}}"
       handle-as="json"
       on-response="handleResponse"
       last-response="{{response}}"></iron-ajax>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'poes-contract',

      properties: {
        foo: {
          type: String,
          value: 'poes-contract',
          notify: true
        },
        web3: {
          type: Object,
          observer: "_web3"
        },
        webready: {
          observer: "_web3"
        },
        balance: {
          type: Number,
          notify: true,
          observer: "_balance"
        },
        account: {

        },
        contract: {
          type: String,
          observer: "_contract"
        },
        contractaddress: {
          type: String
        },
        globalkeystore: {
          type: Object,
          observer: "_keystore"
        },
        memberstatus: {
          type: Number,
          notify:true
        }
      },

      ready: function() {

      },

      _web3: function() {
        console.log("poes contract kent web3js ", this.web3);
        console.log("contract adres van deze club=", this.contractaddress);
        this.balance = this.web3.fromWei(this.web3.eth.getBalance(this.account).toNumber(), 'ether');
      },

      _balance: function() {
        console.log("current balance for account ", this.account, ": ", this.balance);
      },

      _contract: function() {
        console.log('YOOOOO');
        this.contracturl = this.resolveUrl('../../contracts/' + this.contract);
        console.log("Got contract! ", JSON.stringify(this.contractjson));
        this.fire('contract-ready');
      },

      handleResponse: function() {
        this.contractjson = this.response;
        //this.stichtNieuweClub();
        this.memberstatus = (this.membershipStatus() == 1 );
        console.log("IK BEN LID VAN DE CLUB=",this.memberstatus);
        //this.runContract();
      },

      _keystore: function() {
        console.log("KEYSTORE: ", this.globalkeystore);
      },

      membershipStatus: function(account){
        var myContract = this.web3.eth.contract(this.contractjson.abi);
        var contractinstance = myContract.at(this.contractaddress);
        var r = contractinstance.membershipStatus('0x' + this.account);
        console.log('result van MS voor',this.account,'=',r.toNumber(10));
        return r.toNumber(10);
      },

      stichtNieuweClub : function(){
        console.log('maak een nieuwe club');
            var self = this;

        this.web3.eth.getGasPrice(function(err, result) {

          var gasPrice = result;
          var txOptions = {
            gasPrice: gasPrice.toNumber(10),
            gasLimit: 3000000,
            value: 3*1e18,
            nonce: new Date().getTime(),
            data: self.contractjson.bytecode
          };
          console.log('de txoptions van jouw nieuwe club is ',txOptions);
          var contractData = lightwallet.txutils.createContractTx( self.account, txOptions);
          console.log('de createContractTx van jouw nieuwe club is ',contractData);

          var signedTx = self.globalkeystore.signTx(contractData.tx, 'testing', self.account);
          console.log('de signTx van jouw nieuwe club is ',signedTx);


          self.web3.eth.sendRawTransaction(signedTx
          , function(err, txhash) {
            console.log('error: ' + err);
            console.log('txhash: ' + txhash);          

            if (!err){
              console.log('de nieuwe club van account ',self.account,' heeft contractid ',contractData.addr);
              self.contractaddress = contractData.addr;
            }else{
              console.log('je nieuwe club kan niet worden gemaakt. jammer...');
            }

            console.log('okee?');

          });

/*

          self.lastcontractaddress = contractData.addr;

          console.log('Signed Contract creation TX: ' + signedTx)
          console.log('')
          console.log('Contract Address: ' + contractData.addr)
          console.log('')
*/
        });
      },

      addMember: function(newMemberAddress,cb) {
        var self = this;

        var myContract = this.web3.eth.contract(self.contractjson.abi);
        var contractinstance = myContract.at(self.contractaddress);

        console.log('de inviter account=',self.account);
        console.log('de newmember account=', newMemberAddress);
        console.log('het contract adres=', self.contractaddress);

/*
        var r = contractinstance.membershipStatus('0x1d7ae02955135c2d29f0b66cdace63df134986d5');
        console.log('result van MS=',r.toNumber(10));


        this.web3.eth.getGasPrice(function(err, result) {

        contractinstance.addMember('0x2b38d512d3f3cfef030c34bc9e5c697e9b095857',{ gasPrice: result.toNumber(10),value:6*1e18,gas:3000000,from:self.account},function(err){
          console.log('yow');
        });
});*/

        contractinstance.MemberAdded(function(err,res){
          console.log('MEMBERADDED SUSKE');
          console.log('err',err);
          console.log('res',res);
        });

        this.web3.eth.getGasPrice(function(err, result) {

          var gasPrice = result.toNumber(10);
          var txOptions = {
            gasPrice: gasPrice,
            gasLimit: 3000000,
            value: 6 * 1e18,
            nonce: 30000,
            to: self.contractaddress
          };

          //console.log("ABI: ", self.globalkeystore);

          var maaklidTx = lightwallet.txutils.functionTx(self.contractjson.abi, 'addMember', [ '0x' +newMemberAddress], txOptions);
          var signedRegisterTx = self.globalkeystore.signTx(maaklidTx, 'testing', self.account)

          // inject signedRegisterTx into the network...
          console.log('Signed register key TX: ' + signedRegisterTx);

          self.web3.eth.sendRawTransaction(signedRegisterTx
          , function(err, txhash) {
            console.log('error: ' + err);
            console.log('txhash: ' + txhash);
            if (cb){
              cb(err,txhash);
            }
          });

        });

      }
    });
  })();
  </script>
</dom-module>
