<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="poes-contract">
  <template>
    <iron-ajax
       auto
       url="{{contracturl}}"
       handle-as="json"
       on-response="handleResponse"
       last-response="{{response}}"></iron-ajax>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'poes-contract',

      properties: {
        web3: {
          type: Object,
          observer: "_web3"
        },
        webready: {
          observer: "_web3"
        },
        balance: {
          type: Number,
          notify: true,
          observer: "_balance"
        },
        globalkeystore: {
          type: Object,
          observer: "_keystore"
        },
        account: {
          type:String
        },
        memberstatus: {
          type: Number,
          notify:true
        },
        contractaddress: {
          type: String,
          value: "0x83883514f7fcb0cf627829d067f0e8488201f6b9"
        }
      },

      ready: function() {
        this.contracturl = this.resolveUrl('../../contracts/' + this.contract);
        console.log("Got contract! ", JSON.stringify(this.contractjson));
        this.fire('contract-ready');
      },

      _web3: function() {
        console.log("poes contract kent web3js ", this.web3);
        console.log("contract adres van deze club=", this.contractaddress);
        this.balance = this.web3.fromWei(this.web3.eth.getBalance(this.account).toNumber(), 'ether');
      },

      _balance: function() {
        console.log("current balance for account ", this.account, ": ", this.balance);
      },

      handleResponse: function() {
        this.contractjson = this.response;
        //this.stichtNieuweClub();
        this.memberstatus = (this.membershipStatus() == 1 );
        console.log("IK BEN LID VAN DE CLUB=",this.memberstatus);
        //this.runContract();
      },

      _keystore: function() {
        console.log("KEYSTORE: ", this.globalkeystore);
      },

      membershipStatus: function(account){
        var myContract = this.web3.eth.contract(this.contractjson.abi);
        var contractinstance = myContract.at(this.contractaddress);
        var r = contractinstance.membershipStatus('0x' + this.account);
        console.log('result van MS voor',this.account,'=',r.toNumber(10));
        return r.toNumber(10);
      },

      stichtNieuweClub : function(){
        console.log('maak een nieuwe club');
        /*
            var self = this;

        this.web3.eth.getGasPrice(function(err, result) {

          var gasPrice = result;
          var txOptions = {
            gasPrice: gasPrice.toNumber(10),
            gasLimit: 3000000,
            value: 3*1e18,
            nonce: new Date().getTime(),
            data: self.contractjson.bytecode
          };
          console.log('de txoptions van jouw nieuwe club is ',txOptions);
          var contractData = lightwallet.txutils.createContractTx( self.account, txOptions);
          console.log('de createContractTx van jouw nieuwe club is ',contractData);

          var signedTx = self.globalkeystore.signTx(contractData.tx, 'testing', self.account);
          console.log('de signTx van jouw nieuwe club is ',signedTx);


          self.web3.eth.sendRawTransaction(signedTx
          , function(err, txhash) {
            console.log('error: ' + err);
            console.log('txhash: ' + txhash);          

            if (!err){
              console.log('de nieuwe club van account ',self.account,' heeft contractid ',contractData.addr);
              self.contractaddress = contractData.addr;
            }else{
              console.log('je nieuwe club kan niet worden gemaakt. jammer...');
            }

            console.log('okee?');

          });

*/
/*
          self.lastcontractaddress = contractData.addr;

          console.log('Signed Contract creation TX: ' + signedTx)
          console.log('')
          console.log('Contract Address: ' + contractData.addr)
          console.log('')
*/
        
      },

      addMember: function(newMemberAddress,cb) {
        var self = this;


        // creation of contract object
        var MyContract = this.web3.eth.contract(contract.abi);
        var myContractInstance = MyContract.at(poezencontract);

        var options = {
          from: this.account,
          value: 6 * 1e18,
          gas: 3141590,
          gasPrice: gasPrice,
          nonce: Math.floor(Math.random(999999)) + new Date().getTime(),
        };

        var newMember = '0x' + newMemberAddress;

        console.log('adding member ',newMember);
        console.log('contract options',options);


        var result = myContractInstance.addMember.sendTransaction(newMember, options,
          function(err, result) {
            if (err != null) {
              console.log(err);
              console.log("ERROR: Transaction didn't go through. See console.");
            } else {
              console.log("Transaction Successful!");
              console.log(result);              
            }
          }
        );

        myContractInstance.MemberAdded(function(err,res){
          console.log('MEMBERADDED triggered SUSKE');
          console.log('err',err);
          console.log('res',res);
        });

      }
    });
  })();
  </script>
</dom-module>
