<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="poes-contract">
  <template>
    <iron-ajax
       auto
       url="{{contracturl}}"
       handle-as="json"
       on-response="handleResponse"
       last-response="{{response}}"></iron-ajax>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'poes-contract',

      properties: {
        foo: {
          type: String,
          value: 'poes-contract',
          notify: true
        },
        web3: {
          type: Object,
          observer: "_web3"
        },
        webready: {
          observer: "_web3"
        },
        balance: {
          type: Number,
          notify: true,
          observer: "_balance"
        },
        account: {

        },
        contract: {
          type: String,
          observer: "_contract"
        },
        contractaddress: {
          type: String
        },
        globalkeystore: {
          type: Object,
          observer: "_keystore"
        }
      },

      ready: function() {

      },

      _web3: function() {
        console.log("poes contract kent web3js ", this.web3);
        this.balance = this.web3.fromWei(this.web3.eth.getBalance(this.account).toNumber(), 'ether');
      },

      _balance: function() {
        console.log("current balance for account ", this.account, ": ", this.balance);
      },

      _contract: function() {
        console.log('YOOOOO');
        this.contracturl = this.resolveUrl('../../contracts/' + this.contract);
        console.log("Got contract! ", JSON.stringify(this.contractjson));
      },

      handleResponse: function() {
        this.contractjson = this.response;
        //console.log("Contract JSON: ", this.contractjson);
        //this.runContract();
      },

      _keystore: function() {
        console.log("KEYSTORE: ", this.globalkeystore);
      },

      addMember: function(newMemberAddress,cb) {
        var self = this;

        var account =  this.account;


        var myContract = this.web3.eth.contract(self.contractjson.abi);
        var contractinstance = myContract.at(self.contractaddress);
/*
        var r = contractinstance.membershipStatus('0x1d7ae02955135c2d29f0b66cdace63df134986d5');
        console.log('result van MS=',r.toNumber(10));


        this.web3.eth.getGasPrice(function(err, result) {

        contractinstance.addMember('0x2b38d512d3f3cfef030c34bc9e5c697e9b095857',{ gasPrice: result.toNumber(10),value:6*1e18,gas:3000000,from:self.account},function(err){
          console.log('yow');
        });
});*/

        contractinstance.MemberAdded(function(err,res){
          console.log('MEMBERADDED SUSKE');
          console.log('err',err);
          console.log('res',res);
        });

        this.web3.eth.getGasPrice(function(err, result) {

          var gasPrice = result.toNumber(10);
          var txOptions = {
            gasPrice: gasPrice,
            gasLimit: 3000000,
            value: 6 * 1e18,
            nonce: 30000,
            to: self.contractaddress
          };

          //console.log("ABI: ", self.globalkeystore);

          var maaklidTx = lightwallet.txutils.functionTx(self.contractjson.abi, 'addMember', [newMemberAddress], txOptions)
          var signedRegisterTx = self.globalkeystore.signTx(maaklidTx, 'testing', account)

          // inject signedRegisterTx into the network...
          console.log('Signed register key TX: ' + signedRegisterTx);

          self.web3.eth.sendRawTransaction(signedRegisterTx
          , function(err, txhash) {
            console.log('error: ' + err);
            console.log('txhash: ' + txhash);
            if (cb){
              cb(err,txhash);
            }
          });

        });

      }
    });
  })();
  </script>
</dom-module>
